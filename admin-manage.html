<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Management - Sale Support System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .sla-urgent { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { background-color: #fee2e2; } 50% { background-color: #fecaca; } 100% { background-color: #fee2e2; } }
    </style>
</head>
<body class="bg-slate-50 flex min-h-screen">

    <aside id="sidebar-placeholder" class="hidden lg:block w-64 bg-white border-r border-slate-200"></aside>

    <div class="flex-1 flex flex-col min-w-0">
        <header id="topbar-placeholder" class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40 h-16 flex items-center px-6"></header>

        <main class="p-4 md:p-8">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-slate-800">แผงจัดการงาน Admin (Pending Tasks)</h2>
                <p class="text-sm text-slate-500">แสดงเฉพาะงานที่กำลังดำเนินการ และนับถอยหลัง SLA ตามเวลาทำการ</p>
            </div>

            <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden border border-slate-200">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-100">
                                <th class="p-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">ความด่วน</th>
                                <th class="p-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">ผู้แจ้ง/เบอร์ติดต่อ</th>
                                <th class="p-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">หัวข้อ (SLA)</th>
                                <th class="p-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">เวลาที่แจ้ง</th>
                                <th class="p-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">เวลาที่เหลือ (SLA)</th>
                                <th class="p-6 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="admin-ticket-list" class="divide-y divide-slate-50">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAa2uSD_tjNqYE2eXnZcn75h_jAVscDG-c",
            authDomain: "salesupportsystemapp.firebaseapp.com",
            projectId: "salesupportsystemapp",
            storageBucket: "salesupportsystemapp.firebasestorage.app",
            messagingSenderId: "840890441207",
            appId: "1:840890441207:web:f3a5076d46e963a90de2f2"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // โหลด Sidebar/Topbar
        fetch('./components/sidebar.html').then(r => r.text()).then(h => document.getElementById('sidebar-placeholder').innerHTML = h).catch(()=>{});

        // ตั้งค่า SLA (ชั่วโมง)
        const slaConfig = { "internet": 4, "billing": 24, "installation": 8 };

        // ฟังก์ชันคำนวณเวลาที่เหลือ (Business Hours: 08:30 - 17:30, Mon-Fri)
        function calculateRemainingSLA(startTime, slaHours) {
            const now = new Date();
            const start = startTime.toDate();
            
            // เพิ่มชั่วโมง SLA (แบบง่ายเพื่อแสดงผลเบื้องต้น - ในระบบจริงจะใช้ Library เช่น date-fns-tz เพื่อความแม่นยำสูง)
            const deadline = new Date(start.getTime() + (slaHours * 60 * 60 * 1000));
            const diffMs = deadline - now;
            
            if (diffMs < 0) return { text: "Over SLA", color: "text-red-600 font-black", urgent: true };
            
            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const mins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            let color = "text-green-600";
            if (hours < 2) color = "text-orange-600 font-bold";
            if (hours < 1) color = "text-red-500 font-black sla-urgent";

            return { text: `${hours}ชม. ${mins}น.`, color: color, urgent: hours < 1 };
        }

        // ดึงข้อมูล Real-time เฉพาะงานที่ยังไม่เสร็จ
        const q = query(
            collection(db, "tickets"), 
            where("status", "in", ["On Progress", "Open"]), 
            orderBy("createdAt", "asc")
        );

        onSnapshot(q, (snap) => {
            const list = document.getElementById('admin-ticket-list');
            list.innerHTML = snap.docs.map(doc => {
                const t = doc.data();
                const slaHours = slaConfig[t.topic] || 24;
                const slaStatus = calculateRemainingSLA(t.createdAt, slaHours);
                
                return `
                    <tr class="${slaStatus.urgent ? 'bg-red-50/30' : 'hover:bg-slate-50'} transition-colors">
                        <td class="p-6">
                            <span class="w-3 h-3 rounded-full block ${slaStatus.urgent ? 'bg-red-500 animate-ping' : 'bg-slate-300'}"></span>
                        </td>
                        <td class="p-6">
                            <p class="text-sm font-bold text-slate-700">${t.owner || 'Unknown'}</p>
                            <p class="text-xs text-slate-400">${t.id_number}</p>
                        </td>
                        <td class="p-6">
                            <p class="text-sm font-bold text-slate-700 capitalize">${t.topic}</p>
                            <p class="text-[10px] text-slate-400">SLA Standard: ${slaHours} Hours</p>
                        </td>
                        <td class="p-6 text-sm text-slate-500">
                            ${t.createdAt?.toDate().toLocaleString('th-TH', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'})}
                        </td>
                        <td class="p-6">
                            <span class="text-sm ${slaStatus.color}">${slaStatus.text}</span>
                        </td>
                        <td class="p-6 text-right">
                            <button onclick="processTicket('${doc.id}')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-blue-700 transition shadow-md">
                                รับเรื่อง / ปิดงาน
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        });

        // ฟังก์ชันรับเรื่อง/ปิดงาน (ตัวอย่าง)
        window.processTicket = async (id) => {
            const note = prompt("ระบุหมายเหตุการปิดงาน:");
            if (note) {
                await updateDoc(doc(db, "tickets", id), {
                    status: "Success",
                    adminNote: note,
                    adminName: "Admin User", // สมมติชื่อ Admin
                    closedAt: serverTimestamp()
                });
                alert("ปิดงานเรียบร้อย!");
            }
        };
    </script>
</body>
</html>
