<header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-slate-100 px-4 md:px-8 py-4 shadow-sm">
    <div class="flex items-center justify-between">
        
        <div class="flex items-center gap-3">
            <button onclick="window.toggleMobileMenu()" class="lg:hidden w-10 h-10 flex items-center justify-center rounded-xl bg-slate-50 text-[#5c56f1] border border-slate-100 active:scale-95 transition-all">
                <i class="fa-solid fa-bars-staggered text-lg"></i>
            </button>

            <div id="tp-avatar-circle" class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br from-[#5c56f1] to-[#7c77f5] rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-indigo-100 ring-2 ring-white shrink-0">
                ?
            </div>
            
            <div class="flex flex-col min-w-0">
                <div class="flex items-center gap-2">
                    <span id="tp-fullname" class="text-slate-800 font-bold leading-tight text-sm md:text-lg truncate max-w-[120px] md:max-w-none">โหลดชื่อ...</span>
                    <span id="tp-username" class="hidden sm:inline text-[#5c56f1] text-[10px] font-black uppercase tracking-widest bg-indigo-50 px-2 py-0.5 rounded-md">@user</span>
                </div>
                <span id="tp-email" class="text-slate-400 text-[10px] md:text-xs truncate max-w-[150px] md:max-w-none font-medium mt-0.5">email@loading.com</span>
            </div>
        </div>

        <div class="flex items-center bg-slate-50 px-3 md:px-5 py-2 rounded-xl border border-slate-100">
            <div class="flex items-center gap-2">
                <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                <div id="tp-clock" class="text-sm md:text-2xl font-black text-slate-700 tracking-tighter min-w-[60px] md:min-w-[100px] text-right">00:00:00</div>
            </div>
        </div>
    </div>
</header>

<script type="module">
    import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // จัดการ Firebase App Instance
    let app;
    try { app = getApp(); } catch (e) {
        const firebaseConfig = {
            apiKey: "AIzaSyAa2uSD_tjNqYE2eXnZcn75h_jAVscDG-c",
            authDomain: "salesupportsystemapp.firebaseapp.com",
            projectId: "salesupportsystemapp",
            storageBucket: "salesupportsystemapp.firebasestorage.app",
            messagingSenderId: "840890441207",
            appId: "1:840890441207:web:f3a5076d46e963a90de2f2"
        };
        app = initializeApp(firebaseConfig);
    }
    
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- นาฬิกา ---
    setInterval(() => {
        const now = new Date();
        const clockEl = document.getElementById('tp-clock');
        if(clockEl) clockEl.innerText = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    }, 1000);

    // --- ดึงข้อมูล Profile ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                const userDoc = await getDoc(doc(db, "admin", user.uid));
                const data = userDoc.exists() ? userDoc.data() : {};
                
                document.getElementById('tp-fullname').innerText = data.name || 'Sale Support User';
                document.getElementById('tp-username').innerText = `@${data.username || 'user'}`;
                document.getElementById('tp-email').innerText = data.email || user.email;
                document.getElementById('tp-avatar-circle').innerText = (data.name || 'S').charAt(0).toUpperCase();
            } catch (err) { console.error("Topbar Error:", err); }
        }
    });
</script>
