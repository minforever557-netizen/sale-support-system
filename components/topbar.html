<header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-slate-100 px-8 py-4">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        
        <div class="flex items-center gap-4">
            <div id="tp-avatar-circle" class="w-12 h-12 bg-[#5c56f1] rounded-2xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-indigo-100">
                ?
            </div>
            <div class="flex flex-col">
                <div class="flex items-center gap-2">
                    <span id="tp-fullname" class="text-slate-800 font-bold leading-tight">กำลังโหลด...</span>
                    <span class="text-slate-300">|</span>
                    <span id="tp-username" class="text-[#5c56f1] text-xs font-black uppercase tracking-wider">@username</span>
                </div>
                <span id="tp-email" class="text-slate-400 text-xs">email@example.com</span>
            </div>
        </div>

        <div class="flex flex-col md:items-end bg-slate-50 px-6 py-2.5 rounded-[1.25rem] border border-slate-100">
            <div id="tp-clock" class="text-xl font-bold text-slate-700 tracking-tight leading-none">00:00:00</div>
            <div id="tp-date" class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">วันที่กำลังโหลด...</div>
        </div>
    </div>
</header>

<script type="module">
    import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ใช้ App ที่ initialize ไว้แล้ว หรือ init ใหม่ถ้ายังไม่มี
    let app;
    try { app = getApp(); } catch (e) {
        const firebaseConfig = {
            apiKey: "AIzaSyAa2uSD_tjNqYE2eXnZcn75h_jAVscDG-c",
            authDomain: "salesupportsystemapp.firebaseapp.com",
            projectId: "salesupportsystemapp",
            storageBucket: "salesupportsystemapp.firebasestorage.app",
            messagingSenderId: "840890441207",
            appId: "1:840890441207:web:f3a5076d46e963a90de2f2"
        };
        app = initializeApp(firebaseConfig);
    }
    
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- Logic นาฬิกา ---
    function startTopbarClock() {
        const update = () => {
            const now = new Date();
            const clockEl = document.getElementById('tp-clock');
            const dateEl = document.getElementById('tp-date');
            if(clockEl) clockEl.innerText = now.toLocaleTimeString('th-TH', { hour12: false });
            if(dateEl) dateEl.innerText = now.toLocaleDateString('th-TH', { 
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
            });
        };
        setInterval(update, 1000);
        update();
    }

    // --- Logic ดึงข้อมูล User ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = await getDoc(doc(db, "admin", user.uid));
            const data = userDoc.exists() ? userDoc.data() : {};
            
            const name = data.name || user.displayName || 'User';
            const username = data.username || user.email.split('@')[0];

            if(document.getElementById('tp-fullname')) document.getElementById('tp-fullname').innerText = name;
            if(document.getElementById('tp-username')) document.getElementById('tp-username').innerText = `@${username}`;
            if(document.getElementById('tp-email')) document.getElementById('tp-email').innerText = user.email;
            if(document.getElementById('tp-avatar-circle')) document.getElementById('tp-avatar-circle').innerText = name[0].toUpperCase();
        }
    });

    startTopbarClock();
</script>
