<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Sale Support System</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./css/style.css">
</head>

<body class="flex h-screen overflow-hidden bg-slate-50">

<!-- SIDEBAR -->
<aside id="sidebar-container"
class="w-64 shrink-0 h-full bg-white border-r border-slate-200"></aside>

<!-- RIGHT AREA -->
<div class="flex-1 flex flex-col min-w-0">

<div id="topbar-container"></div>

<!-- ================= MAIN ================= -->
<main class="p-6 md:p-10 max-w-7xl mx-auto w-full space-y-8">

<header class="flex items-center justify-between">

<div>
<h1 class="text-3xl font-bold text-slate-800">Dashboard</h1>
<p class="text-slate-400 text-sm mt-1">
ภาพรวมเคสที่คุณเปิดใช้งานในระบบ
</p>
</div>

<button class="btn-primary">
➕ สร้าง Ticket ใหม่
</button>

</header>

<!-- ===== STATUS SUMMARY ===== -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6">

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">เคสทั้งหมด</p>
<h2 id="totalCase" class="text-3xl font-bold mt-2">0</h2>
</div>

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">รอดำเนินการ</p>
<h2 id="pendingCase" class="text-3xl font-bold mt-2">0</h2>
</div>

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">กำลังดำเนินการ</p>
<h2 id="progressCase" class="text-3xl font-bold mt-2">0</h2>
</div>

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">เสร็จสิ้น</p>
<h2 id="doneCase" class="text-3xl font-bold mt-2">0</h2>
</div>

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">ปิดงาน</p>
<h2 id="closeCase" class="text-3xl font-bold mt-2">0</h2>
</div>

</div>

<!-- ===== RECENT TICKETS ===== -->
<div class="glass-card p-8">

<div class="flex items-center justify-between mb-6">
<h2 class="text-xl font-bold">เคสล่าสุดของคุณ</h2>

<span class="status-badge status-badge-green">
REALTIME
</span>
</div>

<div class="overflow-x-auto">
<table class="w-full text-sm">

<thead class="text-slate-400 border-b">
<tr>
<th class="text-left py-3">Ticket ID</th>
<th class="text-left">หัวข้อ</th>
<th class="text-left">ทีม</th>
<th class="text-left">สถานะ</th>
<th class="text-left">วันที่</th>
</tr>
</thead>

<tbody id="recentTicketTable">
<tr>
<td colspan="5" class="text-center py-10 text-slate-400">
กำลังโหลด...
</td>
</tr>
</tbody>

</table>
</div>
</div>

</main>
</div>

<script type="module">
    // 1. Import ตรงจาก Firebase CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // 2. ตั้งค่า Config (ใส่ค่าเดิมของคุณ)
    const firebaseConfig = {
        apiKey: "AIzaSyAa2uSD_tjNqYE2eXnZcn75h_jAVscDG-c",
        authDomain: "salesupportsystemapp.firebaseapp.com",
        projectId: "salesupportsystemapp",
        storageBucket: "salesupportsystemapp.firebasestorage.app",
        messagingSenderId: "840890441207",
        appId: "1:840890441207:web:f3a5076d46e963a90de2f2"
    };

    // 3. Initialize
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    /* ================= การดึงข้อมูล Realtime ================= */
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.replace("login.html");
            return;
        }

        // อ้างอิง Element
        const fields = {
            total: document.getElementById("totalCase"),
            pending: document.getElementById("pendingCase"),
            progress: document.getElementById("progressCase"),
            done: document.getElementById("doneCase"),
            close: document.getElementById("closeCase"),
            table: document.getElementById("recentTicketTable")
        };

        const q = query(collection(db, "tickets"), where("createdBy", "==", user.uid));

        onSnapshot(q, (snapshot) => {
            let stats = { total: 0, pending: 0, progress: 0, done: 0, close: 0 };
            const rows = [];

            snapshot.forEach(doc => {
                const data = doc.data();
                stats.total++;
                if (stats[data.status] !== undefined) stats[data.status]++;
                rows.push({ id: doc.id, ...data });
            });

            // อัปเดตตัวเลขบน Card
            Object.keys(stats).forEach(key => {
                if (fields[key]) fields[key].innerText = stats[key].toLocaleString();
            });

            // อัปเดตตาราง
            renderTable(rows, fields.table);
        });
    });

    function renderTable(rows, tableEl) {
        rows.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        tableEl.innerHTML = "";

        if (rows.length === 0) {
            tableEl.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-slate-400">ยังไม่มีข้อมูล</td></tr>`;
            return;
        }

        rows.slice(0, 5).forEach(t => {
            const tr = document.createElement("tr");
            tr.className = "border-b hover:bg-slate-50";
            tr.innerHTML = `
                <td class="py-4 font-semibold">#${t.id.slice(0, 5)}</td>
                <td>${t.title || t.topic || "-"}</td>
                <td>${t.team || t.sender_team || "-"}</td>
                <td><span class="status-badge status-badge-green uppercase text-[10px]">${t.status}</span></td>
                <td class="text-slate-500">${t.createdAt ? t.createdAt.toDate().toLocaleDateString("th-TH") : "-"}</td>
            `;
            tableEl.appendChild(tr);
        });
    }
</script>


<script src="./js/layout.js"></script>
<script type="module" src="./js/sidebar-role.js"></script>

</body>
</html>
