<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Sale Support System</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./css/style.css">
</head>

<body class="flex h-screen overflow-hidden bg-slate-50">

<!-- SIDEBAR -->
<aside id="sidebar-container"
class="w-64 shrink-0 h-full bg-white border-r border-slate-200"></aside>

<!-- RIGHT AREA -->
<div class="flex-1 flex flex-col min-w-0">

<div id="topbar-container"></div>

<!-- ================= MAIN ================= -->
<main class="p-6 md:p-10 max-w-7xl mx-auto w-full space-y-8">

<header class="flex items-center justify-between">

<div>
<h1 class="text-3xl font-bold text-slate-800">Dashboard</h1>
<p class="text-slate-400 text-sm mt-1">
‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
</p>
</div>

<button class="btn-primary">
‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Ticket ‡πÉ‡∏´‡∏°‡πà
</button>

</header>

<!-- ===== STATUS SUMMARY ===== -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6">

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
<h2 id="totalCase" class="text-3xl font-bold mt-2">0</h2>
</div>

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
<h2 id="pendingCase" class="text-3xl font-bold mt-2">0</h2>
</div>

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
<h2 id="progressCase" class="text-3xl font-bold mt-2">0</h2>
</div>

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p>
<h2 id="doneCase" class="text-3xl font-bold mt-2">0</h2>
</div>

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</p>
<h2 id="closeCase" class="text-3xl font-bold mt-2">0</h2>
</div>

</div>

<!-- ===== RECENT TICKETS ===== -->
<div class="glass-card p-8">

<div class="flex items-center justify-between mb-6">
<h2 class="text-xl font-bold">‡πÄ‡∏Ñ‡∏™‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>

<span class="status-badge status-badge-green">
REALTIME
</span>
</div>

<div class="overflow-x-auto">
<table class="w-full text-sm">

<thead class="text-slate-400 border-b">
<tr>
<th class="text-left py-3">Ticket ID</th>
<th class="text-left">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
<th class="text-left">‡∏ó‡∏µ‡∏°</th>
<th class="text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
<th class="text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
</tr>
</thead>

<tbody id="recentTicketTable">
<tr>
<td colspan="5" class="text-center py-10 text-slate-400">
‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
</td>
</tr>
</tbody>

</table>
</div>
</div>

</main>
</div>

<!-- ================= FIREBASE ================= -->
<script type="module">

import { initializeApp } from
"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getFirestore,
collection,
query,
where,
onSnapshot
} from
"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
getAuth,
onAuthStateChanged
} from
"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";


/* ‚úÖ ‡πÉ‡∏ä‡πâ CONFIG ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
const firebaseConfig = {
apiKey: "AIzaSyAa2uSD_tjNqYE2eXnZcn75h_jAVscDG-c",
authDomain: "salesupportsystemapp.firebaseapp.com",
projectId: "salesupportsystemapp",
storageBucket: "salesupportsystemapp.firebasestorage.app",
messagingSenderId: "840890441207",
appId: "1:840890441207:web:f3a5076d46e963a90de2f2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);


/* ================= DASHBOARD REALTIME ================= */
onAuthStateChanged(auth,(user)=>{

if(!user){
window.location.replace("login.html");
return;
}

/* üî• IMPORTANT
   ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ orderBy ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô Firestore index error */
const q = query(
collection(db,"tickets"),
where("createdBy","==",user.uid)
);

onSnapshot(q,(snapshot)=>{

let total=0,pending=0,progress=0,done=0,close=0;

const rows=[];

snapshot.forEach(doc=>{
const data=doc.data();
total++;

switch(data.status){
case "pending": pending++; break;
case "progress": progress++; break;
case "done": done++; break;
case "close": close++; break;
}

rows.push({id:doc.id,...data});
});

/* ===== SORT ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô CLIENT ===== */
rows.sort((a,b)=>{
return (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0);
});

/* ===== KPI ===== */
totalCase.innerText=total;
pendingCase.innerText=pending;
progressCase.innerText=progress;
doneCase.innerText=done;
closeCase.innerText=close;


/* ===== TABLE ===== */
const table=document.getElementById("recentTicketTable");
table.innerHTML="";

rows.slice(0,5).forEach(t=>{

const tr=document.createElement("tr");
tr.className="border-b hover:bg-slate-50";

tr.innerHTML=`
<td class="py-4 font-semibold">${t.id}</td>
<td>${t.title??"-"}</td>
<td>${t.team??"-"}</td>
<td>
<span class="status-badge status-badge-green">
${t.status??"-"}
</span>
</td>
<td>${formatDate(t.createdAt)}</td>
`;

table.appendChild(tr);

});

if(total===0){
table.innerHTML=`
<tr>
<td colspan="5" class="text-center py-10 text-slate-400">
‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
</td>
</tr>`;
}

});

});


function formatDate(timestamp){
if(!timestamp) return "-";
return timestamp.toDate().toLocaleDateString("th-TH",{
year:"numeric",
month:"short",
day:"numeric"
});
}

</script>

<script src="./js/layout.js"></script>
<script type="module" src="./js/sidebar-role.js"></script>
   <script type="module" src="firebase.js"></script>

</body>
</html>
