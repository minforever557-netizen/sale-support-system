<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Sale Support System</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./css/style.css">
</head>

<body class="flex h-screen overflow-hidden bg-slate-50">

<!-- SIDEBAR -->
<aside id="sidebar-container"
class="w-64 shrink-0 h-full bg-white border-r border-slate-200"></aside>

<!-- RIGHT AREA -->
<div class="flex-1 flex flex-col min-w-0">

<div id="topbar-container"></div>

<!-- ================= MAIN ================= -->
<main class="p-6 md:p-10 max-w-7xl mx-auto w-full space-y-8">

<header class="flex items-center justify-between">

<div>
<h1 class="text-3xl font-bold text-slate-800">Dashboard</h1>
<p class="text-slate-400 text-sm mt-1">
ภาพรวมเคสที่คุณเปิดใช้งานในระบบ
</p>
</div>

<button class="btn-primary">
➕ สร้าง Ticket ใหม่
</button>

</header>

<!-- ===== STATUS SUMMARY ===== -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6">

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">เคสทั้งหมด</p>
<h2 id="totalCase" class="text-3xl font-bold mt-2">0</h2>
</div>

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">รอดำเนินการ</p>
<h2 id="pendingCase" class="text-3xl font-bold mt-2">0</h2>
</div>

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">กำลังดำเนินการ</p>
<h2 id="progressCase" class="text-3xl font-bold mt-2">0</h2>
</div>

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">เสร็จสิ้น</p>
<h2 id="doneCase" class="text-3xl font-bold mt-2">0</h2>
</div>

<div class="glass-card p-6">
<p class="text-slate-400 text-sm">ปิดงาน</p>
<h2 id="closeCase" class="text-3xl font-bold mt-2">0</h2>
</div>

</div>

<!-- ===== RECENT TICKETS ===== -->
<div class="glass-card p-8">

<div class="flex items-center justify-between mb-6">
<h2 class="text-xl font-bold">เคสล่าสุดของคุณ</h2>

<span class="status-badge status-badge-green">
REALTIME
</span>
</div>

<div class="overflow-x-auto">
<table class="w-full text-sm">

<thead class="text-slate-400 border-b">
<tr>
<th class="text-left py-3">Ticket ID</th>
<th class="text-left">หัวข้อ</th>
<th class="text-left">ทีม</th>
<th class="text-left">สถานะ</th>
<th class="text-left">วันที่</th>
</tr>
</thead>

<tbody id="recentTicketTable">
<tr>
<td colspan="5" class="text-center py-10 text-slate-400">
กำลังโหลด...
</td>
</tr>
</tbody>

</table>
</div>
</div>

</main>
</div>

<script type="module">
    // 1. Import ตัวแปร db และ auth จากไฟล์ firebase.js ที่คุณเตรียมไว้
    import { db, auth } from "./firebase.js";
    
    // 2. Import ฟังก์ชัน Firestore/Auth ที่จำเป็นจาก CDN
    import { 
        collection, 
        query, 
        where, 
        onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    /* ================= DASHBOARD REALTIME ================= */
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.replace("login.html");
            return;
        }

        // อ้างอิง Element สำหรับแสดงตัวเลข KPI
        const elTotal = document.getElementById("totalCase");
        const elPending = document.getElementById("pendingCase");
        const elProgress = document.getElementById("progressCase");
        const elDone = document.getElementById("doneCase");
        const elClose = document.getElementById("closeCase");
        const tableBody = document.getElementById("recentTicketTable");

        // Query ข้อมูลเฉพาะที่เป็นของ User คนนี้
        const q = query(
            collection(db, "tickets"),
            where("createdBy", "==", user.uid)
        );

        // ฟังการเปลี่ยนแปลงข้อมูลแบบ Realtime
        onSnapshot(q, (snapshot) => {
            let total = 0, pending = 0, progress = 0, done = 0, close = 0;
            const rows = [];

            snapshot.forEach(doc => {
                const data = doc.data();
                total++;

                // นับจำนวนสถานะ
                const status = data.status?.toLowerCase();
                if (status === "pending") pending++;
                else if (status === "progress") progress++;
                else if (status === "done") done++;
                else if (status === "close") close++;

                rows.push({ id: doc.id, ...data });
            });

            // เรียงลำดับตามวันที่สร้าง (Client-side Sort)
            rows.sort((a, b) => {
                const timeA = a.createdAt?.seconds || 0;
                const timeB = b.createdAt?.seconds || 0;
                return timeB - timeA;
            });

            // ✅ แสดงตัวเลขในหน้า Dashboard
            if (elTotal) elTotal.innerText = total.toLocaleString();
            if (elPending) elPending.innerText = pending.toLocaleString();
            if (elProgress) elProgress.innerText = progress.toLocaleString();
            if (elDone) elDone.innerText = done.toLocaleString();
            if (elClose) elClose.innerText = close.toLocaleString();

            // ✅ แสดงข้อมูลในตาราง (5 รายการล่าสุด)
            tableBody.innerHTML = "";

            if (rows.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-10 text-slate-400">ยังไม่มีข้อมูล</td>
                    </tr>`;
            } else {
                rows.slice(0, 5).forEach(t => {
                    const tr = document.createElement("tr");
                    tr.className = "border-b hover:bg-slate-50 transition-colors";
                    
                    // ปรับสี Badge ตามสถานะ
                    const statusClass = t.status === 'close' ? 'status-badge-green' : 'status-badge-blue';

                    tr.innerHTML = `
                        <td class="py-4 font-semibold text-slate-700">#${t.id.slice(0, 5)}...</td>
                        <td class="py-4">${t.title || t.topic || "-"}</td>
                        <td class="py-4">${t.team || t.sender_team || "-"}</td>
                        <td class="py-4">
                            <span class="status-badge ${statusClass} uppercase text-[10px]">
                                ${t.status || "pending"}
                            </span>
                        </td>
                        <td class="py-4 text-slate-500">${formatDate(t.createdAt || t.timestamp)}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
        });
    });

    // ฟังก์ชันจัดรูปแบบวันที่
    function formatDate(timestamp) {
        if (!timestamp) return "-";
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString("th-TH", {
            year: "numeric",
            month: "short",
            day: "numeric"
        });
    }
</script>


<script src="./js/layout.js"></script>
<script type="module" src="./js/sidebar-role.js"></script>
   <script type="module" src="firebase.js"></script>

</body>
</html>
