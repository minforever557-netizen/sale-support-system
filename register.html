<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลงทะเบียนพนักงาน | SALE Support System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css"> 
</head>
<body class="min-h-screen flex items-center justify-center p-4 md:p-10">

    <div class="bg-white p-8 md:p-12 rounded-[3rem] shadow-2xl w-full max-w-2xl border-b-[12px] border-green-600 fade-in-up relative overflow-hidden">
        
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-green-50 rounded-full"></div>
        <div class="absolute top-8 right-8 text-green-200 text-4xl opacity-40">
            <i class="fas fa-user-shield"></i>
        </div>

        <div class="mb-10 relative">
            <h2 class="text-4xl font-black text-green-600 tracking-tighter">สร้างบัญชีใหม่</h2>
            <p class="text-orange-500 font-bold tracking-[0.1em] text-xs uppercase mt-1">Registration for Sale Support System</p>
        </div>

        <form id="reg-form" class="space-y-6 relative">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="input-group">
                    <label class="text-[11px] font-bold text-gray-400 uppercase ml-1 mb-2 block tracking-widest">Username (ไอดี)</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-gray-400">
                            <i class="fas fa-id-badge"></i>
                        </span>
                        <input type="text" id="reg-username" 
                            class="w-full pl-11 pr-4 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl focus:border-orange-400 focus:bg-white outline-none transition-all duration-300 font-medium" 
                            placeholder="กรุณาระบุ ID ที่ต้องการ" required>
                    </div>
                </div>
                <div class="input-group">
                    <label class="text-[11px] font-bold text-gray-400 uppercase ml-1 mb-2 block tracking-widest">ชื่อ-นามสกุล</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-gray-400">
                            <i class="fas fa-signature"></i>
                        </span>
                        <input type="text" id="reg-name" 
                            class="w-full pl-11 pr-4 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl focus:border-orange-400 focus:bg-white outline-none transition-all duration-300 font-medium" 
                            placeholder="ระบุชื่อจริง" required>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="input-group">
                    <label class="text-[11px] font-bold text-gray-400 uppercase ml-1 mb-2 block tracking-widest">อีเมล</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-gray-400">
                            <i class="fas fa-envelope"></i>
                        </span>
                        <input type="email" id="reg-email" 
                            class="w-full pl-11 pr-4 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl focus:border-orange-400 focus:bg-white outline-none transition-all duration-300 font-medium" 
                            placeholder="email@company.com" required>
                    </div>
                </div>
                <div class="input-group">
                    <label class="text-[11px] font-bold text-gray-400 uppercase ml-1 mb-2 block tracking-widest">เบอร์โทรศัพท์</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-gray-400">
                            <i class="fas fa-phone-flip"></i>
                        </span>
                        <input type="text" id="reg-phone" 
                            class="w-full pl-11 pr-4 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl focus:border-orange-400 focus:bg-white outline-none transition-all duration-300 font-medium" 
                            placeholder="08x-xxxxxxx">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 bg-green-50/50 rounded-[2rem] border-2 border-dashed border-green-100">
                <div class="input-group">
                    <label class="text-[11px] font-bold text-green-600 uppercase ml-1 mb-2 block tracking-widest">ทีมหลัก (MAIN TEAM)</label>
                    <div class="relative">
                        <select id="reg-main" class="w-full pl-4 pr-10 py-4 bg-white border-2 border-gray-100 rounded-2xl focus:border-green-500 outline-none transition-all appearance-none cursor-pointer font-bold text-gray-700" required>
                            <option value="" disabled selected>กำลังโหลดทีมหลัก...</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-green-600 pointer-events-none"></i>
                    </div>
                </div>
                <div class="input-group">
                    <label class="text-[11px] font-bold text-green-600 uppercase ml-1 mb-2 block tracking-widest">ทีมย่อย (SUB TEAM)</label>
                    <div class="relative">
                        <select id="reg-sub" class="w-full pl-4 pr-10 py-4 bg-white border-2 border-gray-100 rounded-2xl focus:border-green-500 outline-none transition-all appearance-none cursor-pointer font-bold text-gray-700" required disabled>
                            <option value="" disabled selected>เลือกทีมหลักก่อน</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-green-600 pointer-events-none"></i>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label class="text-[11px] font-bold text-gray-400 uppercase ml-1 mb-2 block tracking-widest">กำหนดรหัสผ่าน</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-gray-400">
                        <i class="fas fa-lock"></i>
                    </span>
                    <input type="password" id="reg-pass" 
                        class="w-full pl-11 pr-4 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl focus:border-orange-400 focus:bg-white outline-none transition-all duration-300 font-medium" 
                        placeholder="••••••••" required>
                </div>
            </div>

            <div class="pt-4 text-center">
                <button type="submit" id="submitBtn" 
                    class="w-full bg-orange-500 text-white py-5 rounded-3xl font-bold text-lg hover:bg-orange-600 shadow-xl shadow-orange-100 transition-all active:scale-95 flex justify-center items-center space-x-2">
                    <span>ยืนยันการลงทะเบียน</span>
                    <div id="btnLoader" class="spinner hidden"></div> </button>
                
                <p class="mt-8 text-gray-400 text-sm">
                    มีบัญชีอยู่แล้ว? <a href="login.html" class="text-green-600 font-black hover:text-green-700 transition-all underline underline-offset-4">เข้าสู่ระบบที่นี่</a>
                </p>
            </div>
        </form>
    </div>

   <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyAa2uSD_tjNqYE2eXnZcn75h_jAVscDG-c", 
            authDomain: "salesupportsystemapp.firebaseapp.com", 
            projectId: "salesupportsystemapp", 
            storageBucket: "salesupportsystemapp.firebasestorage.app", 
            messagingSenderId: "840890441207", 
            appId: "1:840890441207:web:f3a5076d46e963a90de2f2" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allTeams = [];
        const regForm = document.getElementById('reg-form');
        const submitBtn = document.getElementById('submitBtn');
        const btnLoader = document.getElementById('btnLoader'); // ต้องมี ID นี้ใน HTML
        const card = document.querySelector('.fade-in-up');

        // --- 1. โหลดข้อมูลทีมทั้งหมด ---
        async function loadInitialTeams() {
            const mainSelect = document.getElementById('reg-main');
            try {
                const snap = await getDocs(collection(db, "teams"));
                allTeams = snap.docs.map(d => ({ id: d.id, ...d.data() }));

                mainSelect.innerHTML = '<option value="" disabled selected>เลือกทีมหลัก</option>';
                const mainTeams = allTeams.filter(t => t.type === "main");
                
                mainTeams.forEach(t => {
                    mainSelect.add(new Option(t.name, t.id)); 
                });
            } catch (err) {
                console.error("Load teams error:", err);
                mainSelect.innerHTML = '<option value="">โหลดข้อมูลล้มเหลว</option>';
            }
        }

        // --- 2. กรองทีมย่อยตามทีมหลักที่เลือก ---
        document.getElementById('reg-main').onchange = (e) => {
            const selectedMainDocId = e.target.value;
            const subSelect = document.getElementById('reg-sub');
            const filteredSubs = allTeams.filter(t => t.type === "sub" && t.parentId === selectedMainDocId);

            subSelect.innerHTML = '<option value="" disabled selected>เลือกทีมย่อย</option>';
            
            if (filteredSubs.length > 0) {
                subSelect.disabled = false;
                filteredSubs.forEach(t => {
                    subSelect.add(new Option(t.name, t.name));
                });
            } else {
                subSelect.disabled = true;
                subSelect.innerHTML = '<option value="">ไม่มีทีมย่อยในกลุ่มนี้</option>';
            }
        };

        // --- 3. บันทึกข้อมูลลงทะเบียน พร้อม Animation ---
        regForm.onsubmit = async (e) => {
            e.preventDefault();
            const mainSelectEl = document.getElementById('reg-main');
            const mainTeamName = mainSelectEl.options[mainSelectEl.selectedIndex].text;
            const subTeamName = document.getElementById('reg-sub').value;

            // --- [Start Animation] ---
            submitBtn.disabled = true;
            submitBtn.classList.add('scale-95', 'opacity-90');
            if (btnLoader) btnLoader.classList.remove('hidden'); // แสดง spinner นาย
            const btnSpan = submitBtn.querySelector('span');
            if (btnSpan) btnSpan.innerText = "กำลังสร้างบัญชี...";

            const email = document.getElementById('reg-email').value.trim();
            const pass = document.getElementById('reg-pass').value;

            try {
                // สร้าง User ใน Auth
                const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                
                // บันทึกข้อมูลใน Firestore (Collection admin)
                await setDoc(doc(db, "admin", userCred.user.uid), {
                    username: document.getElementById('reg-username').value.trim(),
                    name: document.getElementById('reg-name').value.trim(),
                    email: email,
                    phone: document.getElementById('reg-phone').value.trim(),
                    Team: mainTeamName,
                    "Sub Team": subTeamName,
                    role: "user",
                    createdAt: new Date().toISOString()
                });

                // --- [Success Animation] ---
                if (btnSpan) btnSpan.innerText = "ลงทะเบียนสำเร็จ!";
                if (btnLoader) btnLoader.classList.add('hidden');
                submitBtn.classList.replace('bg-orange-500', 'bg-green-600');

                setTimeout(() => {
                    if (card) {
                        // เล่นท่า Fade Out สวนทางขาเข้า
                        card.style.transition = "all 0.6s cubic-bezier(0.4, 0, 0.2, 1)";
                        card.style.opacity = "0";
                        card.style.transform = "translateY(-40px)";
                    }
                    setTimeout(() => {
                        window.location.href = "login.html";
                    }, 600);
                }, 500);

            } catch (err) {
                alert("ล้มเหลว: " + err.message);
                // Reset ปุ่ม
                submitBtn.disabled = false;
                submitBtn.classList.remove('scale-95', 'opacity-90');
                if (btnSpan) btnSpan.innerText = "ลงทะเบียนเข้าใช้งาน";
                if (btnLoader) btnLoader.classList.add('hidden');
            }
        };

        loadInitialTeams();
    </script>
</body>
</html>
